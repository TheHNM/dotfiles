#!/bin/sh

status() {
    # mpd
    artisttitle="$(mpc -f "[[%artist% - ]%title%]|[%file%]" 2>/dev/null | grep -v "volume:" | head -n 1)"
    if [ -n "$(mpc status | head -n 2 | tac | head -n 1 | grep paused)" ]; then
        printf "%s" "[mpd] paused "
    elif [ -n "$artisttitle" ]; then
        printf "%s" "[mpd] $artisttitle "
    fi

    # Spotify
    playerstatus=$(playerctl status)
    if [ "$playerstatus" = "Paused" ]; then
        printf "%s" "[spotify] paused "
    elif [ "$playerstatus" = "Playing" ]; then
        printf "%s" "[spotify] $(playerctl metadata --format '{{ artist }} - {{ title }}') "
    fi

    # Wifi
    wifissid=$(nmcli -t -f active,ssid dev wifi | grep '^yes' | cut -d\' -f2 | cut -d: -f2)
    [ -n "$wifissid" ] && printf "%s" "[wifi] $wifissid "

    # Ethernet
    [ "$(cat /sys/class/net/e*/carrier)" = "1" ] && printf "%s" "[eth] con "

    # Volume
    volume="$(pulsemixer --get-volume | awk '{print $1}')%"
    [ "$(pulsemixer --get-mute)" = "1" ] && volume="mute"
    printf "%s" "[vol] $volume "

    # Lightlevel
    lightlevel=$(light -G)
    [ "$lightlevel" != 0.00 ] && printf "[light] %.0f%% " $lightlevel

    # Battery
    capacity=$(cat /sys/class/power_supply/BAT0/capacity)
    if [ -n "$capacity" ]; then
        batstatus=$(cat /sys/class/power_supply/BAT0/status)
        case "$batstatus" in
            Charging) batstatus="chr" ;;
            Discharging) batstatus="dchr" ;;
            *) batstatus="" ;;
        esac
        printf "%s" "[bat] $batstatus $capacity% "
    fi

    # Date
    printf "%s" "[date] $(date +"%d.%m.%Y %H:%M:%S")"
}

while true; do
    xsetroot -name "$(status)"
    sleep 1
done
